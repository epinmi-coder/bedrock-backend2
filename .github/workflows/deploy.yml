name: Deploy to AWS

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - delete

env:
  AWS_REGION: us-east-1
  STACK_NAME: bedrock-backend-production
  INSTANCE_TYPE: t2.micro

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete stack
        if: github.event.inputs.action == 'delete'
        run: |
          echo "ğŸ—‘ï¸ Deleting stack: ${{ env.STACK_NAME }}"
          aws cloudformation delete-stack --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }}
          echo "â³ Waiting for deletion..."
          aws cloudformation wait stack-delete-complete --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }}
          echo "âœ… Stack deleted"

      - name: Deploy stack
        if: github.event.inputs.action == 'deploy'
        run: |
          echo "ğŸš€ Deploying stack: ${{ env.STACK_NAME }}"
          
          # Check if stack exists
          if aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Stack exists - updating..."
            COMMAND="update-stack"
          else
            echo "Stack does not exist - creating..."
            COMMAND="create-stack"
          fi
          
          # Hardcoded allowed origins
          ALLOWED_ORIGINS='["http://localhost:5173","https://da57vzl0vgd9l.cloudfront.net","http://localhost:5174"]'
          
          # Deploy
          aws cloudformation $COMMAND \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://cloudformation/backend-infrastructure.yaml \
            --parameters \
              ParameterKey=Environment,ParameterValue=production \
              ParameterKey=InstanceType,ParameterValue=${{ env.INSTANCE_TYPE }} \
              ParameterKey=KeyPairName,ParameterValue=${{ secrets.EC2_KEY_PAIR_NAME }} \
              ParameterKey=DatabaseURL,ParameterValue="${{ secrets.DATABASE_URL }}" \
              ParameterKey=AWSAccessKeyId,ParameterValue="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              ParameterKey=AWSSecretAccessKey,ParameterValue="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              ParameterKey=AllowedOrigins,ParameterValue="$ALLOWED_ORIGINS" \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --tags Key=Environment,Value=production Key=Project,Value=bedrock-backend || echo "No updates needed"
          
          # Wait for completion
          if [ "$COMMAND" = "create-stack" ]; then
            echo "â³ Waiting for stack creation..."
            aws cloudformation wait stack-create-complete --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }}
          else
            echo "â³ Waiting for stack update..."
            aws cloudformation wait stack-update-complete --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }} || echo "No changes"
          fi
          
          echo "âœ… Deployment complete!"

      - name: Get outputs
        if: github.event.inputs.action == 'deploy'
        run: |
          echo "ğŸ“Š Stack outputs:"
          
          ALB_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerURL`].OutputValue' \
            --output text 2>/dev/null || echo "")
          
          echo "ğŸŒ Load Balancer URL: $ALB_URL"
          echo "ğŸ”— Health Check: $ALB_URL/health"
          echo "ğŸ“š API Docs: $ALB_URL/docs"
