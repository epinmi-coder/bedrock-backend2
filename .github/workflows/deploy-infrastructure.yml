name: üöÄ Deploy to AWS Production

on:
  push:
    branches:
      - main

env:
  ENVIRONMENT: production
  STACK_NAME: bedrock-backend-production
  INSTANCE_TYPE: t2.micro
  REGION: us-east-1

jobs:
  deploy:
    name: Deploy CloudFormation Stack
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.REGION }}

      # 3Ô∏è‚É£ Install AWS CLI (in case runner doesn‚Äôt have it)
      - name: Install AWS CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y awscli jq

      # 4Ô∏è‚É£ Set and check deployment environment variables
      - name: Prepare deployment variables
        run: |
          echo "ENVIRONMENT=${{ env.ENVIRONMENT }}" >> $GITHUB_ENV
          echo "STACK_NAME=${{ env.STACK_NAME }}" >> $GITHUB_ENV
          echo "INSTANCE_TYPE=${{ env.INSTANCE_TYPE }}" >> $GITHUB_ENV

          # Convert comma-separated origins to JSON array format
          # Input: http://localhost:5173,https://da57vzl0vgd9l.cloudfront.net,http://localhost:5174
          # Output: ["http://localhost:5173","https://da57vzl0vgd9l.cloudfront.net","http://localhost:5174"]
          ORIGINS_CSV="${{ secrets.ALLOWED_ORIGINS }}"
          ORIGINS_JSON=$(echo "$ORIGINS_CSV" | awk -F',' '{printf "["; for(i=1;i<=NF;i++){printf "\"%s\"", $i; if(i<NF) printf ","}; printf "]"}')
          echo "ALLOWED_ORIGINS_JSON=$ORIGINS_JSON" >> $GITHUB_ENV

          echo "Original origins: $ORIGINS_CSV"
          echo "Converted to JSON: $ORIGINS_JSON"

      # 5Ô∏è‚É£ Deploy the CloudFormation stack
      - name: Deploy stack to AWS
        run: |
          echo "üöÄ Deploying stack: $STACK_NAME"
          echo "   Environment: $ENVIRONMENT"
          echo "   Instance Type: $INSTANCE_TYPE"
          echo "   Allowed Origins: $ALLOWED_ORIGINS_JSON"

          aws cloudformation create-stack \
            --stack-name "$STACK_NAME" \
            --template-body file://cloudformation/backend-infrastructure.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameters \
              ParameterKey=Environment,ParameterValue="$ENVIRONMENT" \
              ParameterKey=InstanceType,ParameterValue="$INSTANCE_TYPE" \
              ParameterKey=KeyPairName,ParameterValue="${{ secrets.EC2_KEY_PAIR_NAME }}" \
              ParameterKey=DatabaseURL,ParameterValue="${{ secrets.DATABASE_URL }}" \
              ParameterKey=AWSAccessKeyId,ParameterValue="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              ParameterKey=AWSSecretAccessKey,ParameterValue="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              ParameterKey=AllowedOrigins,ParameterValue="$ALLOWED_ORIGINS_JSON" \
            || echo "Stack may already exist, attempting update..."

          # If stack exists, update instead
          aws cloudformation update-stack \
            --stack-name "$STACK_NAME" \
            --template-body file://cloudformation/backend-infrastructure.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameters \
              ParameterKey=Environment,ParameterValue="$ENVIRONMENT" \
              ParameterKey=InstanceType,ParameterValue="$INSTANCE_TYPE" \
              ParameterKey=KeyPairName,ParameterValue="${{ secrets.EC2_KEY_PAIR_NAME }}" \
              ParameterKey=DatabaseURL,ParameterValue="${{ secrets.DATABASE_URL }}" \
              ParameterKey=AWSAccessKeyId,ParameterValue="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              ParameterKey=AWSSecretAccessKey,ParameterValue="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              ParameterKey=AllowedOrigins,ParameterValue="$ALLOWED_ORIGINS_JSON" \
            || echo "‚úÖ No updates to perform"

      # 6Ô∏è‚É£ Confirm successful deployment
      - name: Verify stack status
        run: |
          echo "‚è≥ Checking stack status..."
          aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
            --query "Stacks[0].StackStatus"
