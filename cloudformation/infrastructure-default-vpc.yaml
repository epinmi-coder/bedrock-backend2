AWSTemplateFormatVersion: "2010-09-09"
Description: "Simple CloudFormation template using Default VPC - EC2 instances behind ALB"

Parameters:
  Environment:
    Type: String
    Default: production
    Description: Environment name

  InstanceType:
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.micro
      - t2.small
    Description: EC2 instance type

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: EC2 Key Pair for SSH access

  DatabaseURL:
    Type: String
    NoEcho: true
    Description: PostgreSQL database connection string

  AWSAccessKeyId:
    Type: String
    NoEcho: true
    Description: AWS Access Key ID for Bedrock

  AWSSecretAccessKey:
    Type: String
    NoEcho: true
    Description: AWS Secret Access Key for Bedrock

  AllowedOrigins:
    Type: String
    Default: '["*"]'
    Description: CORS allowed origins as JSON array string

  MinSize:
    Type: Number
    Default: 1
    Description: Minimum number of EC2 instances

  MaxSize:
    Type: Number
    Default: 4
    Description: Maximum number of EC2 instances

  DesiredCapacity:
    Type: Number
    Default: 1
    Description: Desired number of EC2 instances

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID (use default VPC)

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnet IDs for ALB and EC2 instances (select at least 2 in different AZs)

Resources:
  # ==================== Security Groups ====================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${Environment}-bedrock-alb-sg
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP from anywhere
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS from anywhere
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${Environment}-bedrock-alb-sg

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${Environment}-bedrock-ec2-sg
      GroupDescription: Security group for EC2 instances
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow traffic from ALB on port 8000
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: Allow SSH access
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${Environment}-bedrock-ec2-sg

  # ==================== IAM Roles ====================
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${Environment}-bedrock-ec2-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource: "*"
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/bedrock-backend*

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub ${Environment}-bedrock-ec2-profile
      Roles:
        - !Ref EC2Role

  # ==================== Application Load Balancer ====================
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${Environment}-bedrock-alb
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets: !Ref SubnetIds
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub ${Environment}-bedrock-alb

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${Environment}-bedrock-tg
      Port: 8000
      Protocol: HTTP
      VpcId: !Ref VpcId
      HealthCheckEnabled: true
      HealthCheckPath: /health
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200
      TargetType: instance
      Tags:
        - Key: Name
          Value: !Sub ${Environment}-bedrock-tg

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  # ==================== Launch Template ====================
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub ${Environment}-bedrock-lt
      LaunchTemplateData:
        ImageId: !Sub "{{resolve:ssm:/aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id}}"
        InstanceType: !Ref InstanceType
        KeyName: !Ref KeyPairName
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !Ref EC2SecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub ${Environment}-bedrock-instance
              - Key: Environment
                Value: !Ref Environment
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -e

            # Log everything
            exec > >(tee /var/log/user-data.log)
            exec 2>&1

            echo "Starting instance setup at $(date)"

            # Update system
            apt-get update
            apt-get upgrade -y

            # Install dependencies
            apt-get install -y python3-pip python3-venv git supervisor curl

            # Install CloudWatch agent
            wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
            dpkg -i amazon-cloudwatch-agent.deb

            # Create application directory
            mkdir -p /opt/bedrock-backend
            cd /opt/bedrock-backend

            # Create virtual environment
            python3 -m venv venv
            source venv/bin/activate

            # Install pip packages (initial setup - code will be deployed separately)
            pip install --upgrade pip
            pip install fastapi uvicorn python-dotenv boto3 psycopg2-binary sqlalchemy alembic

            # Create .env file
            cat > .env <<EOF
            DATABASE_URL=${DatabaseURL}
            AWS_ACCESS_KEY_ID=${AWSAccessKeyId}
            AWS_SECRET_ACCESS_KEY=${AWSSecretAccessKey}
            AWS_DEFAULT_REGION=${AWS::Region}
            ALLOWED_ORIGINS=${AllowedOrigins}
            ENVIRONMENT=${Environment}
            EOF

            # Create placeholder app (will be replaced by actual deployment)
            cat > main.py <<'PYEOF'
            from fastapi import FastAPI
            from fastapi.middleware.cors import CORSMiddleware
            import os

            app = FastAPI(title="Bedrock Backend API")

            # CORS
            app.add_middleware(
                CORSMiddleware,
                allow_origins=["*"],
                allow_credentials=True,
                allow_methods=["*"],
                allow_headers=["*"],
            )

            @app.get("/")
            def root():
                return {"status": "ok", "message": "Bedrock Backend API is running"}

            @app.get("/health")
            def health():
                return {"status": "healthy"}
            PYEOF

            # Create supervisor config
            cat > /etc/supervisor/conf.d/bedrock-backend.conf <<EOF
            [program:bedrock-backend]
            directory=/opt/bedrock-backend
            command=/opt/bedrock-backend/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
            user=ubuntu
            autostart=true
            autorestart=true
            stderr_logfile=/var/log/bedrock-backend.err.log
            stdout_logfile=/var/log/bedrock-backend.out.log
            environment=PATH="/opt/bedrock-backend/venv/bin"
            EOF

            # Set permissions
            chown -R ubuntu:ubuntu /opt/bedrock-backend

            # Start supervisor
            systemctl enable supervisor
            systemctl restart supervisor

            # Configure CloudWatch agent
            cat > /opt/aws/amazon-cloudwatch-agent/etc/config.json <<EOF
            {
              "logs": {
                "logs_collected": {
                  "files": {
                    "collect_list": [
                      {
                        "file_path": "/var/log/bedrock-backend.out.log",
                        "log_group_name": "/aws/ec2/bedrock-backend",
                        "log_stream_name": "{instance_id}/application"
                      },
                      {
                        "file_path": "/var/log/bedrock-backend.err.log",
                        "log_group_name": "/aws/ec2/bedrock-backend",
                        "log_stream_name": "{instance_id}/error"
                      }
                    ]
                  }
                }
              }
            }
            EOF

            /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
              -a fetch-config \
              -m ec2 \
              -s \
              -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json

            echo "Instance setup completed at $(date)"

  # ==================== Auto Scaling Group ====================
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub ${Environment}-bedrock-asg
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: !Ref MinSize
      MaxSize: !Ref MaxSize
      DesiredCapacity: !Ref DesiredCapacity
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      VPCZoneIdentifier: !Ref SubnetIds
      TargetGroupARNs:
        - !Ref TargetGroup
      Tags:
        - Key: Name
          Value: !Sub ${Environment}-bedrock-instance
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref Environment
          PropagateAtLaunch: true

  # ==================== Auto Scaling Policy ====================
  ScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 70.0

  # ==================== CloudWatch Log Group ====================
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/ec2/bedrock-backend
      RetentionInDays: 14

  # ==================== CloudWatch Alarms ====================
  HighCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${Environment}-bedrock-high-cpu
      AlarmDescription: Alert when CPU exceeds 80%
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup

  UnhealthyHostAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${Environment}-bedrock-unhealthy-hosts
      AlarmDescription: Alert when unhealthy host count is greater than 0
      MetricName: UnHealthyHostCount
      Namespace: AWS/ApplicationELB
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 0
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TargetGroup
          Value: !GetAtt TargetGroup.TargetGroupFullName
        - Name: LoadBalancer
          Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName

Outputs:
  LoadBalancerURL:
    Description: Application Load Balancer URL
    Value: !Sub http://${ApplicationLoadBalancer.DNSName}
    Export:
      Name: !Sub ${Environment}-bedrock-alb-url

  LoadBalancerDNS:
    Description: Application Load Balancer DNS Name
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub ${Environment}-bedrock-alb-dns
